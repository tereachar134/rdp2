name: Ubuntu RDP (Official Install)

on: 
  workflow_dispatch:

jobs:
  rdp-access:
    runs-on: ubuntu-latest

    steps:
    - name: 1. Install Desktop (XFCE) & XRDP
      run: |
        sudo apt-get update
        sudo apt-get install -y xfce4 xfce4-goodies xrdp
        echo xfce4-session > ~/.xsession
        sudo service xrdp restart

    - name: 2. Set User Password
      run: |
        echo "runner:P@ssw0rd!" | sudo chpasswd

    - name: 3. Install Ngrok (Official Apt Method)
      run: |
        # 1. Add the Ngrok GPG key
        curl -sSL https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        
        # 2. Add the Ngrok repository (using 'buster' is safer for Ubuntu compatibility than 'bookworm')
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        
        # 3. Update and Install
        sudo apt update
        sudo apt install ngrok

    - name: 4. Auth & Start Tunnel
      run: |
        # Authenticate using the Secret from GitHub (Safe)
        ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        
        # Start Tunnel for RDP (TCP 3389), NOT HTTP 80
        nohup ngrok tcp 3389 &
        
        # Wait for it to start
        sleep 10

    - name: 5. Get Connection Info
      run: |
        # Fetch the URL
        curl --silent http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url' > ngrok_url.txt
        
        # Clean the URL
        CLEAN_URL=$(cat ngrok_url.txt | sed 's/tcp:\/\///')
        
        echo "::notice title=RDP Address::$CLEAN_URL"
        echo "::notice title=Username::runner"
        echo "::notice title=Password::P@ssw0rd!"

    - name: 6. Keep Session Alive
      run: |
        echo "Session is active. Press Cancel Workflow to stop."
        while true; do sleep 60; done
