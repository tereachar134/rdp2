name: Ubuntu RDP (Ngrok Fixed)

on: 
  workflow_dispatch:

jobs:
  rdp-access:
    runs-on: ubuntu-latest

    steps:
    - name: 1. Install Desktop Environment (XFCE) & XRDP
      run: |
        sudo apt-get update
        sudo apt-get install -y xfce4 xfce4-goodies xrdp
        echo xfce4-session > ~/.xsession
        sudo service xrdp restart

    - name: 2. Set User Password
      run: |
        echo "runner:P@ssw0rd!" | sudo chpasswd

    - name: 3. Install & Start Ngrok
      env:
        # We pull the secret from GitHub and map it to a local variable
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xvzf ngrok-v3-stable-linux-amd64.tgz
        
        # --- THE FIX IS HERE ---
        # We use $NGROK_AUTH_TOKEN (Bash syntax), not $env:... (PowerShell syntax)
        ./ngrok config add-authtoken $NGROK_AUTH_TOKEN
        
        nohup ./ngrok tcp 3389 &
        sleep 10

    - name: 4. Get Connection Info
      run: |
        curl --silent http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url' > ngrok_url.txt
        CLEAN_URL=$(cat ngrok_url.txt | sed 's/tcp:\/\///')
        
        echo "::notice title=RDP Address::$CLEAN_URL"
        echo "::notice title=Username::runner"
        echo "::notice title=Password::P@ssw0rd!"

    - name: 5. Keep Session Alive
      run: |
        echo "Session is active. Press Cancel Workflow to stop."
        while true; do sleep 60; done
