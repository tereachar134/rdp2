name: Ubuntu RDP (Official & Fixed)

on: 
  workflow_dispatch:

jobs:
  rdp-access:
    runs-on: ubuntu-latest

    steps:
    - name: 1. Install Desktop (XFCE) & XRDP
      run: |
        sudo apt-get update
        sudo apt-get install -y xfce4 xfce4-goodies xrdp
        echo xfce4-session > ~/.xsession
        sudo service xrdp restart

    - name: 2. Set User Password
      run: |
        # Set password for default user 'runner'
        echo "runner:P@ssw0rd!" | sudo chpasswd

    - name: 3. Install Ngrok (Official Way)
      run: |
        # Add Ngrok GPG Key
        curl -sSL https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        
        # Add Ngrok Repo
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        
        # Install
        sudo apt update
        sudo apt install ngrok

    - name: 4. Auth & Start Tunnel
      run: |
        # --- FIX: This line caused your error. Do not use 'secrets...' ---
        ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        
        # Start Tunnel for RDP (TCP 3389)
        # We use 'nohup' so it runs in the background
        nohup ngrok tcp 3389 &
        
        # Wait 10 seconds for it to connect
        sleep 10

    - name: 5. Get Connection Info
      run: |
        # Get the URL from local API
        curl --silent http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url' > ngrok_url.txt
        
        # Remove 'tcp://' so you can copy-paste it
        CLEAN_URL=$(cat ngrok_url.txt | sed 's/tcp:\/\///')
        
        # Print info to GitHub Summary
        echo "::notice title=RDP Address::$CLEAN_URL"
        echo "::notice title=Username::runner"
        echo "::notice title=Password::P@ssw0rd!"

    - name: 6. Keep Session Alive
      run: |
        echo "Session is active. Press Cancel Workflow to stop."
        while true; do sleep 60; done
